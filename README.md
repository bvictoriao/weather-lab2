# Лабораторная работа №2  

Вариант 21 — История погоды (по дате)

Идея:
A → отправляет дату и город.
B → возвращает температуру за прошлый период.
Задача:
- Реактивный WebClient GET.
- Передача параметров.
- Логирование через фильтры.
(Неоптимальная) логика: B хранит часовые записи в CSV и при каждом
запросе полностью парсит файл, строит список и затем фильтрует по дате с
O(n).
Что нужно сделать: реализовать парсинг full-file + filtering.
Пример:
- Исторические данные создаются заново (коллекция на 10 000 записей).
- Поиск по дате реализован вручную через перебор по всей коллекции.
- Преобразование чисел через BigDecimal, хотя это не требуется.
- Дублирующий расчёт среднего по всем датам, который нигде не
используется.

Проект состоит из двух микросервисов:

- **Сервис A (клиент)** — порт 8080  
  Принимает запросы от пользователя и перенаправляет их в Сервис B

- **Сервис B (сервер)** — порт 8081  
  Обрабатывает запросы и возвращает исторические данные о погоде


# Требования к окружению

- Java 17+
- Maven 3.6+
- Spring Boot 3.5.9

# Запуск сервисов

## Запуск Сервиса B (сервер)

```bash
# Перейдите в папку service-b
cd service-b

# Сборка и запуск
./mvnw clean spring-boot:run

```

## Запуск Сервиса A (клиент)

```bash
# Перейдите в папку service-a
cd service-a

# Сборка и запуск
./mvnw clean spring-boot:run
```
# API

## Сервис A (клиент, порт 8080)

Примеры запросов:

http://localhost:8080/api/weather?date=2025-01-15&city=Moscow  
http://localhost:8080/api/weather?date=2025-02-01&city=London  
http://localhost:8080/api/weather?date=2025-03-15&city=Paris  

---

## Сервис B (сервер, порт 8081)

Прямой доступ (для тестирования):

http://localhost:8081/weather/history?date=2025-01-15&city=Moscow

## Тестовые данные

Период: с 2025-01-01 по 2025-04-14 (104 дня)  
Количество записей: 10 000  
Города: Moscow, London, Paris, Berlin  
Формат: CSV файл weather_data.csv


## Примеры запросов

Рабочие запросы:

http://localhost:8080/api/weather?date=2025-01-15&city=Moscow → 24 записи  
http://localhost:8080/api/weather?date=2025-02-01&city=London → 24 записи  
http://localhost:8080/api/weather?date=2025-03-20&city=Paris → 24 записи  

Запросы за пределами диапазона:

http://localhost:8080/api/weather?date=2025-05-01&city=Moscow → []  
http://localhost:8080/api/weather?date=2025-01-15&city=Tokyo → []


## Особенности неоптимального кода

### 1. Полное чтение CSV файла при каждом запросе

**Что происходит:**  
При каждом запросе Сервис B читает и парсит весь CSV файл (10 000 записей).

**Ожидаемый результат в логах:**  
`Прочитано записей из CSV: 10000` (при каждом запросе)

**Почему неоптимально:**  
Файл перечитывается полностью, даже при запросе данных только за один день.

---

### 2. Линейный поиск O(n)

**Что происходит:**  
Фильтрация данных осуществляется перебором всех 10 000 записей.

**Ожидаемое время обработки:**  
30–80 мс (должно быть значительно меньше при использовании индексов).


---

### 3. Дублирующий расчет среднего значения

**Что происходит:**  
Средняя температура вычисляется дважды в каждом запросе.

**Ожидаемый результат в логах:**  
`Вычислено среднее (не используется): 15.00` (выводится 2 раза)

**Почему неоптимально:**  
Расчет выполняется дважды, а результат не используется.

---

### 4. Ненужное использование BigDecimal

**Что происходит:**  
Температуры хранятся как `BigDecimal` для простых арифметических операций.

# Логирование

## Сервис A (клиент)

**Логируемые события:**

1. **=== Сервис A: Контроллер вызван ===** — вход в контроллер.
2. **=== Сервис A: Исходящий запрос ===** — запрос к Сервису B.
3. **=== Сервис A: Получен ответ ===** — ответ от Сервиса B.

**Дополнительно:**
- Повторные попытки при ошибках (3 попытки с backoff).

---

## Сервис B (сервер)

**Логируемые события:**

1. **=== Сервис B: Входящий запрос ===** — фильтр логирования.
2. **=== ОБРАБОТКА ЗАПРОСА ===** — начало обработки.
3. **Прочитано записей из CSV: 10000** — чтение файла.
4. **Вычислено среднее (не используется): 15.00 (2 раза)** — дублирующий расчет.
5. **Время обработки: XX мс** — время выполнения.
6. **Найдено записей после фильтрации: XX** — результат фильтрации.

---

## Обработка ошибок

### Настройки в Сервисе A
- **Таймаут:** 5 секунд.
- **Повторные попытки:** 3 попытки с экспоненциальным backoff (1, 2, 4 секунды).
- **Обработка ошибок:** возврат пустого массива при неудачных попытках.

### Проверка обработки ошибок
1. Остановите Сервис B.
2. Выполните запрос к Сервису A.
3. В логах Сервиса A будут видны 3 повторные попытки.
4. После неудачных попыток будет возвращен пустой массив `[]`.

https://res.cloudinary.com/dlwg2gnxz/image/upload/v1762355799/acronis_bundle_banner_fl0jed.png




